<!doctype html>
<html>
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-CKQ1EXBHY6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-CKQ1EXBHY6');
  </script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Checkout â€” AhamStree</title>
  <meta name="description" content="Secure checkout. Shipping details and Razorpay payment." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/styles.css" />
</head>

<body>
  <div id="header"></div>

  <div class="container">
    <div class="breadcrumbs" aria-label="Breadcrumb">
      <a href="index.html">Home</a> <span class="sep">â€º</span>
      <a href="cart.html">Cart</a> <span class="sep">â€º</span>
      <span>Checkout</span>
    </div>

    <div class="page-header">
      <div>
        <h1 class="page-title">Checkout</h1>
        <div class="small page-subtitle">Confirm your cart, add shipping details, and pay securely via Razorpay.</div>
      </div>
      <a class="btn ghost" href="cart.html" style="height:40px;">Edit cart</a>
    </div>

    <div id="authBanner" class="card" style="padding:12px 14px; border-radius:16px; display:none; margin-bottom:12px;">
      <div class="small" id="authText"></div>
    </div>

    <!-- Saved address banner (shown for logged-in users with a saved address) -->
    <div id="savedAddressBanner" style="display:none; margin-bottom:12px; padding:14px 16px; border-radius:16px; border:1.5px solid var(--brand); background:var(--brand-light);">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
        <div>
          <div style="font-weight:800; font-size:14px;">ğŸ“ Use your saved address?</div>
          <div class="small" style="margin-top:4px; opacity:.8;" id="savedAddressPreview"></div>
        </div>
        <div style="display:flex; gap:8px;">
          <button type="button" id="useSavedAddress" class="btn" style="padding:8px 14px; font-size:13px;">Use this address</button>
          <button type="button" id="dismissSavedAddress" class="btn secondary" style="padding:8px 14px; font-size:13px;">Enter new</button>
        </div>
      </div>
    </div>

    <div id="warn" class="card" style="padding:12px 14px; border-radius:16px; display:none; border:1px solid rgba(220,20,60,.22); margin-bottom:12px;">
      <div class="small" style="color:crimson;" id="warnText"></div>
    </div>

    <div class="checkout-grid">

      <!-- LEFT: Shipping -->
      <form id="form" class="card" style="padding:16px; border-radius:16px;">
        <h3 style="margin:0 0 8px 0;">Shipping details</h3>
        <div class="small" style="opacity:.8; margin-bottom:12px;">Used for delivery updates and invoice. <span id="loginHint"></span></div>

        <label class="small">Full name</label>
        <input class="input" name="full_name" required placeholder="e.g., Monil Gupta" autocomplete="name" autocapitalize="words" />

        <div style="height:10px;"></div>

        <label class="small">Phone</label>
        <input class="input" type="tel" name="phone" required maxlength="10" placeholder="10-digit mobile" inputmode="numeric" autocomplete="tel" />

        <div style="height:10px;"></div>

        <label class="small">Email (optional)</label>
        <input class="input" type="email" name="email" placeholder="name@email.com" inputmode="email" autocomplete="email" />

        <div style="height:10px;"></div>

        <label class="small">Address line 1</label>
        <input class="input" name="address_line1" required placeholder="House / street" autocomplete="shipping address-line1" autocapitalize="words" />

        <div style="height:10px;"></div>

        <label class="small">Address line 2 (optional)</label>
        <input class="input" name="address_line2" placeholder="Landmark" autocomplete="shipping address-line2" autocapitalize="words" />

        <div style="height:10px;"></div>

        <div class="row city-state-row">
          <div style="flex:1;">
            <label class="small">City</label>
            <input class="input" name="city" required autocomplete="shipping address-level2" autocapitalize="words" />
          </div>
          <div style="flex:1;">
            <label class="small">State</label>
            <input class="input" name="state" required autocomplete="shipping address-level1" autocapitalize="words" />
          </div>
        </div>

        <div style="height:10px;"></div>

        <label class="small">Pincode</label>
        <input class="input" name="pincode" required maxlength="6" placeholder="e.g., 560001" inputmode="numeric" autocomplete="shipping postal-code" />

        <div style="height:18px;"></div>

        <!-- Payment Method Selector -->
        <div style="margin-bottom:14px;">
          <div class="small" style="font-weight:800; margin-bottom:8px;">Payment method</div>
          <div style="display:flex; flex-direction:column; gap:8px;">

            <label id="pmRazorpayLabel" style="display:flex;align-items:center;gap:12px;padding:12px 14px;border:2px solid var(--brand);border-radius:12px;cursor:pointer;background:var(--brand-light);transition:all .15s;">
              <input type="radio" name="payment_method" value="razorpay" id="pmRazorpay" checked style="accent-color:var(--brand);width:16px;height:16px;flex-shrink:0;" />
              <div style="flex:1;">
                <div style="font-weight:800;font-size:14px;">Pay Online</div>
                <div class="small" style="opacity:.75;margin-top:2px;">Cards, UPI, Net Banking via Razorpay</div>
              </div>
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity:.55;flex-shrink:0;"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
            </label>

            <label id="pmCodLabel" style="display:flex;align-items:center;gap:12px;padding:12px 14px;border:2px solid var(--border);border-radius:12px;cursor:pointer;background:#fff;transition:all .15s;">
              <input type="radio" name="payment_method" value="cod" id="pmCod" style="accent-color:var(--brand);width:16px;height:16px;flex-shrink:0;" />
              <div style="flex:1;">
                <div style="font-weight:800;font-size:14px;">Cash on Delivery</div>
                <div class="small" style="opacity:.75;margin-top:2px;">Pay in cash when your order arrives</div>
              </div>
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity:.55;flex-shrink:0;"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"/><line x1="12" y1="12" x2="12" y2="16"/><line x1="10" y1="14" x2="14" y2="14"/></svg>
            </label>

          </div>

          <!-- COD note -->
          <div id="codNote" style="display:none;margin-top:8px;padding:10px 12px;border-radius:10px;background:#fffbeb;border:1px solid #fde68a;">
            <div class="small" style="color:#92400e;">&#x1F4E6; COD orders are confirmed manually. You'll receive a WhatsApp / call confirmation within 2 hours.</div>
          </div>
        </div>

        <div style="height:14px;"></div>

        <button class="btn" type="button" id="payBtn" style="width:100%;">Pay with Razorpay</button>
        <div id="status" class="small" style="margin-top:10px;"></div>

        <div class="small" style="margin-top:12px; opacity:.8;">
          Note: Payments are processed by Razorpay. Youâ€™ll be redirected to a secure payment page.
        </div>
      </form>

      <!-- RIGHT: Order Summary -->
      <div class="card" style="padding:16px; border-radius:16px;">
        <h3 style="margin:0 0 8px 0;">Order summary</h3>
        <div class="small" style="opacity:.8; margin-bottom:12px;">Review your items before payment.</div>

        <div id="summaryItems" style="display:flex; flex-direction:column; gap:10px;"></div>

        <!-- Coupon -->
        <div id="couponBox" style="margin-top:14px;">
          <button id="couponToggle" type="button" style="display:flex;align-items:center;gap:8px;background:var(--brand-light);border:1.5px dashed var(--brand);border-radius:12px;padding:10px 14px;width:100%;cursor:pointer;color:var(--brand);font-weight:700;font-size:14px;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
            <span id="couponToggleLabel">Have a coupon? Tap to apply</span>
          </button>

          <!-- Coupon Panel (hidden by default) -->
          <div id="couponPanel" style="display:none; margin-top:10px; border:1px solid var(--border); border-radius:14px; padding:14px; background:#fff;">
            <div style="font-weight:800; font-size:13px; margin-bottom:10px;">Available coupons</div>

            <div id="couponOptions" style="display:flex; flex-direction:column; gap:8px; margin-bottom:14px;"></div>

            <div style="font-weight:700; font-size:12px; opacity:.7; margin-bottom:6px;">Or enter a code manually</div>
            <div style="display:flex; gap:8px;">
              <input id="couponInput" class="input" placeholder="e.g. WELCOME10" style="flex:1; font-size:14px;" autocapitalize="characters" />
              <button id="applyCoupon" type="button" class="btn" style="height:42px; padding:0 16px; flex-shrink:0;">Apply</button>
            </div>
            <div id="couponMsg" class="small" style="margin-top:8px; min-height:18px;"></div>
          </div>
        </div>

        <div style="height:12px;"></div>
        <div style="border-top:1px solid rgba(255,255,255,.08); padding-top:12px;">
          <div style="display:flex; justify-content:space-between; gap:10px;">
            <div class="small">Subtotal</div>
            <div class="small" id="subtotal">â‚¹0</div>
          </div>
          <div id="discountRow" style="display:none; justify-content:space-between; gap:10px; margin-top:6px;">
            <div class="small">Discount</div>
            <div class="small" id="discount">-â‚¹0</div>
          </div>
          <div style="display:flex; justify-content:space-between; gap:10px; margin-top:6px;">
            <div class="small" id="gstLabel">GST</div>
            <div class="small" id="gst">â‚¹0</div>
          </div>

          <div style="display:flex; justify-content:space-between; gap:10px; margin-top:6px;">
            <div class="small">Shipping</div>
            <div class="small" id="shipping">â‚¹0</div>
          </div>
          <div style="display:flex; justify-content:space-between; gap:10px; margin-top:10px; font-weight:900;">
            <div>Total</div>
            <div id="total">â‚¹0</div>
          </div>
        </div>

        <div style="height:12px;"></div>
        <div class="small" style="opacity:.75;">
          If payment fails or is cancelled, you can retry from your cart.
        </div>
      </div>
    </div>
  </div>

  <div id="footer"></div>

  <script type="module">
    import { escapeHtml, escapeAttr, safeSrc } from "./assets/safe.js";

    const statusEl = document.getElementById("status");
    const warnBox = document.getElementById("warn");
    const warnText = document.getElementById("warnText");
    const payBtn = document.getElementById("payBtn");
    const form = document.getElementById("form");

    const showError = (msg) => {
      warnBox.style.display = "block";
      warnText.textContent = msg;
    };
    const clearError = () => {
      warnBox.style.display = "none";
      warnText.textContent = "";
    };

    // ---------- Money / Summary ----------
    // Fallback only. Server (quote-order) should be the source of truth.
    const GST_RATE = 0.05; // fallback only
    const GST_INCLUDED_IN_PRICE = true; // fallback only ("inclusive of all taxes")

    let cartOk = true; // disables Pay if stock is not available
    let appliedCoupon = localStorage.getItem("ahamstree_coupon") || "";

    function money(n) {
      const num = Number(n || 0);
      return "â‚¹" + num.toLocaleString("en-IN", { maximumFractionDigits: 0 });
    }

    function calcGST(netTotal) {
      const rate = Number(GST_RATE || 0);
      const net = Number(netTotal || 0);

      if (!rate || rate <= 0) return { gst: 0, taxable: net };

      if (GST_INCLUDED_IN_PRICE) {
        const taxable = net / (1 + rate);
        const gst = net - taxable;
        return { gst, taxable };
      }

      const gst = net * rate;
      return { gst, taxable: net };
    }

    // âœ… FIXED: complete function (your earlier paste got cut and broke the script)
    async function tryServerQuote({ cart, coupon_code }) {
      try {
        const sbMod = await import("./assets/supabase.js");

        // Add Authorization header only if user is logged in
        const { data: sess } = await sbMod.supabase.auth.getSession();
        const token = sess?.session?.access_token;

        const { data, error } = await sbMod.supabase.functions.invoke("quote-order", {
          body: { cart, coupon_code },
          headers: token ? { Authorization: `Bearer ${token}` } : {}
        });

        if (error) {
          return { ok: false, error: error.message || "Quote error", details: error };
        }
        if (!data) return { ok: false, error: "No quote returned" };
        return { ok: true, data };
      } catch (e) {
        return { ok: false, error: String(e?.message ?? e) };
      }
    }

    async function renderOrderSummary({ coupon_code = "" } = {}) {
      const summaryItems = document.getElementById("summaryItems");
      const subtotalEl = document.getElementById("subtotal");
      const shippingEl = document.getElementById("shipping");
      const totalEl = document.getElementById("total");

      const discountRow = document.getElementById("discountRow");
      const discountEl = document.getElementById("discount");
      const gstEl = document.getElementById("gst");
      const gstLabel = document.getElementById("gstLabel");

      const couponInput = document.getElementById("couponInput");
      const couponMsg = document.getElementById("couponMsg");

      if (!summaryItems || !subtotalEl || !shippingEl || !totalEl) return;

      const cartMod = await import("./assets/cart.js");
      const sbMod = await import("./assets/supabase.js");

      const items = cartMod.getCart?.() || [];
      cartOk = true;

      if (couponInput && coupon_code !== undefined) {
        couponInput.value = String(coupon_code || "");
      }

      if (!items.length) {
        summaryItems.innerHTML = `<div class="small" style="opacity:.75;">Your cart is empty.</div>`;
        subtotalEl.textContent = money(0);
        shippingEl.textContent = money(0);
        totalEl.textContent = money(0);
        if (discountRow) discountRow.style.display = "none";
        if (gstEl) gstEl.textContent = money(0);
        if (gstLabel) gstLabel.textContent = GST_INCLUDED_IN_PRICE ? "GST (included)" : "GST";
        if (couponMsg) couponMsg.textContent = "";
        cartOk = false;
        validateAll({ showErrors: false });
        return;
      }

      // Fetch latest product info (stock + price)
      // IMPORTANT: include reserved_qty so we can compute available = inventory - reserved
      const ids = Array.from(new Set(items.map(i => String(i.product_id))));
      const { data: products, error: prodErr } = await sbMod.supabase
        .from("products")
        .select("id,title,price_inr,sale_price_inr,inventory_qty,reserved_qty,is_active, product_images(image_url, sort_order)")
        .in("id", ids);

      if (prodErr) {
        cartOk = false;
        showError("Could not verify product stock. Please refresh and try again.");
      }

      const pMap = new Map((products || []).map(p => [String(p.id), p]));

      let subtotal = 0;
      let hasStockIssue = false;

      summaryItems.innerHTML = items.map((i) => {
        const pid = String(i.product_id);
        const p = pMap.get(pid);

        const active = p?.is_active !== false;

        const inv = Number(p?.inventory_qty ?? 0);
        const reserved = Number(p?.reserved_qty ?? 0);
        const available = Math.max(inv - reserved, 0);

        const qty = Number(i.qty || 1);

        const okStock = !!p && active && available > 0 && qty <= available;
        if (!okStock) hasStockIssue = true;

        // Price rule: if sale_price_inr is set and lower, use it; else use price_inr
        const basePrice = Number(p?.price_inr ?? i.price_inr ?? 0);
        const hasSale = p?.sale_price_inr != null && Number(p.sale_price_inr) > 0 && Number(p.sale_price_inr) < basePrice;
        const unitPrice = hasSale ? Number(p.sale_price_inr) : basePrice;

        const lineTotal = unitPrice * qty;
        subtotal += lineTotal;

        const imgUrl = (() => {
          const imgs = (p?.product_images ?? []).slice().sort((a,b)=> (a.sort_order??0)-(b.sort_order??0));
          return imgs[0]?.image_url || i.image_url || "";
        })();

        const title = p?.title || i.title || "Item";

        let stockText = "";
        if (!p) stockText = "Unavailable";
        else if (!active || available <= 0) stockText = "Sold out";
        else if (qty > available) stockText = `Only ${available} left`;

        const safeImg = safeSrc(imgUrl);
        const safeAlt = escapeAttr(title);
        const safeTitle = escapeHtml(title);

        return `
          <div style="display:flex; gap:10px; align-items:center;">
            <div style="width:54px;height:64px;border-radius:12px;overflow:hidden;background:#fafafa;flex:0 0 auto;">
              ${safeImg ? `<img src="${safeImg}" alt="${safeAlt}" style="width:100%;height:100%;object-fit:cover;">` : ""}
            </div>

            <div style="flex:1; min-width:0;">
              <div style="font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                ${safeTitle}
              </div>
              <div class="small" style="opacity:.75;">
                ${hasSale
                  ? `<span style="text-decoration:line-through;opacity:.55;margin-right:5px;">${money(basePrice)}</span><span style="color:var(--brand);font-weight:700;">${money(unitPrice)}</span>`
                  : money(unitPrice)
                } Ã— ${qty}
              </div>
              ${stockText ? `<div class="small" style="color:crimson; margin-top:2px;">${stockText}</div>` : ""}
            </div>

            <div style="font-weight:900; flex:0 0 auto;">${money(lineTotal)}</div>
          </div>
        `;
      }).join("");

      if (hasStockIssue) {
        cartOk = false;
        showError("Some items are sold out / exceed available stock. Please go back and edit your cart.");
      } else {
        clearError();
      }

      let shipping = 0; // free shipping for now (can be replaced by server value)
      let discount = 0;
      let gst = calcGST(subtotal - discount + shipping).gst;

      // Default total (fallback)
      let total = GST_INCLUDED_IN_PRICE
        ? (subtotal - discount + shipping)
        : (subtotal - discount + shipping + gst);

      const code = String(coupon_code || "").trim().toUpperCase();
      const payloadCart = items.map(i => ({ product_id: i.product_id, qty: i.qty }));

      // Try server quote ALWAYS (works even without coupon, gives GST breakdown correctly)
      const q = await tryServerQuote({ cart: payloadCart, coupon_code: code || null });

      if (q.ok && q.data) {
        // Use server totals
        subtotal = Number(q.data.subtotal_inr ?? subtotal);
        discount = Number(q.data.discount_inr ?? 0);
        shipping = Number(q.data.shipping_inr ?? shipping);
        gst = Number(q.data.gst_inr ?? gst);
        total = Number(q.data.total_inr ?? total);

        // GST label from server (preferred)
        if (gstLabel) gstLabel.textContent = q.data.gst_included ? "GST (included)" : "GST";

        // Coupon messaging from server
        if (couponMsg) {
          if (code) {
            const c = q.data.coupon;
            if (c?.ok) couponMsg.textContent = `Applied: ${code}`;
            else couponMsg.textContent = c?.message || "Coupon not applied";
          } else {
            couponMsg.textContent = "";
          }
        }

        // If server detected stock issues, block payment too
        if (Array.isArray(q.data.issues) && q.data.issues.length) {
          cartOk = false;
          showError(q.data.issues.join(" â€¢ "));
        }
      } else {
        // Fallback label + coupon message when quote-order not deployed
        if (gstLabel) gstLabel.textContent = GST_INCLUDED_IN_PRICE ? "GST (included)" : "GST";

        if (couponMsg) {
          const details = q?.error ? ` (${q.error})` : "";
          couponMsg.textContent = code
            ? `Coupon preview not available yet. Please check quote-order deployment/secrets.${details}`
            : "";
        }
      }

      // Update GST display
      if (gstEl) gstEl.textContent = money(gst);

      // Discount row
      if (discountRow && discountEl) {
        if (discount > 0) {
          discountRow.style.display = "flex";
          discountEl.textContent = "-" + money(discount);
        } else {
          discountRow.style.display = "none";
          discountEl.textContent = "-" + money(0);
        }
      }

      subtotalEl.textContent = money(subtotal);
      shippingEl.textContent = money(shipping);
      totalEl.textContent = money(total);

      validateAll({ showErrors: false });
    }

    // ---------- Validation ----------
    const isValidEmail = (email) => /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i.test(email);
    const sanitizeText = (s) => String(s || "").trim().replace(/\s+/g, " ");

    const normalizePhone10 = (raw) => {
      let digits = String(raw || "").replace(/\D/g, "");
      if (digits.startsWith("91") && digits.length === 12) digits = digits.slice(2);
      if (digits.startsWith("0") && digits.length === 11) digits = digits.slice(1);
      return digits;
    };

    const normalizePincode6 = (raw) => String(raw || "").replace(/\D/g, "");

    const markInvalid = (inputEl, msg) => {
      inputEl.classList.add("is-invalid");
      inputEl.dataset.error = msg;
    };
    const markValid = (inputEl) => {
      inputEl.classList.remove("is-invalid");
      delete inputEl.dataset.error;
    };
    const clearMarks = (inputEl) => {
      inputEl.classList.remove("is-invalid");
      delete inputEl.dataset.error;
    };

    const validateField = (name, valueRaw) => {
      const v = valueRaw;

      if (name === "full_name") {
        const full = sanitizeText(v);
        if (!full || full.length < 3) return { ok: false, message: "Enter a valid full name (min 3 chars)." };
        return { ok: true };
      }

      if (name === "phone") {
        const phone10 = normalizePhone10(v);
        if (!phone10 || phone10.length !== 10 || !/^[6-9]\d{9}$/.test(phone10)) {
          return { ok: false, message: "Enter a valid 10-digit Indian mobile (starts 6â€“9)." };
        }
        return { ok: true };
      }

      if (name === "email") {
        const email = sanitizeText(v).toLowerCase();
        if (!email) return { ok: true };
        if (!isValidEmail(email)) return { ok: false, message: "Enter a valid email or leave blank." };
        return { ok: true };
      }

      if (name === "address_line1") {
        const a1 = sanitizeText(v);
        if (!a1 || a1.length < 5) return { ok: false, message: "Enter Address line 1 (min 5 chars)." };
        return { ok: true };
      }

      if (name === "city") {
        const city = sanitizeText(v);
        if (!city) return { ok: false, message: "Enter your city." };
        return { ok: true };
      }

      if (name === "state") {
        const state = sanitizeText(v);
        if (!state) return { ok: false, message: "Enter your state." };
        return { ok: true };
      }

      if (name === "pincode") {
        const pin = normalizePincode6(v);
        if (!pin || pin.length !== 6) return { ok: false, message: "Enter a valid 6-digit pincode." };
        return { ok: true };
      }

      return { ok: true };
    };

    const requiredFields = ["full_name", "phone", "address_line1", "city", "state", "pincode"];

    const validateAll = ({ showErrors = false } = {}) => {
      let allOk = true;
      let firstError = null;

      const inputs = form.querySelectorAll("input[name]");
      inputs.forEach((input) => {
        const name = input.name;
        const res = validateField(name, input.value);
        const isRequired = requiredFields.includes(name);

        if ((isRequired || name === "email") && !res.ok) {
          allOk = false;

          if (showErrors || input.dataset.touched === "1") {
            markInvalid(input, res.message);
          } else {
            clearMarks(input);
          }

          if (!firstError) firstError = res.message;
        } else {
          if (!isRequired && name !== "email" && input.value.trim() === "") clearMarks(input);
          else if (name === "email" && input.value.trim() === "") clearMarks(input);
          else markValid(input);
        }
      });

      const canPay = allOk && cartOk;
      payBtn.disabled = !canPay;
      payBtn.style.opacity = canPay ? "1" : "0.6";
      payBtn.style.cursor = canPay ? "pointer" : "not-allowed";

      if (showErrors) {
        if (!allOk && firstError) showError(firstError);
        else clearError();
      }

      return (allOk && cartOk);
    };

    const attachLiveValidation = () => {
      const inputs = form.querySelectorAll("input[name]");
      inputs.forEach((input) => {
        const name = input.name;

        input.addEventListener("input", () => {
          if (name === "phone") input.value = String(input.value || "").replace(/\D/g, "").slice(0, 10);
          if (name === "pincode") input.value = String(input.value || "").replace(/\D/g, "").slice(0, 6);
          validateAll({ showErrors: false });
        });

        input.addEventListener("blur", () => {
          input.dataset.touched = "1";
          validateAll({ showErrors: false });

          const res = validateField(name, input.value);
          const isRequired = requiredFields.includes(name);
          if ((isRequired || name === "email") && !res.ok) showError(res.message);
          else clearError();
        });
      });
    };

    // ---------- Build payload ----------
    const buildShipping = () => {
      const fd = new FormData(form);
      const raw = Object.fromEntries(fd.entries());

      const full_name = sanitizeText(raw.full_name);
      const phone10 = normalizePhone10(raw.phone);
      const email = sanitizeText(raw.email).toLowerCase();
      const address_line1 = sanitizeText(raw.address_line1);
      const address_line2 = sanitizeText(raw.address_line2);
      const city = sanitizeText(raw.city);
      const state = sanitizeText(raw.state);
      const pincode = normalizePincode6(raw.pincode);

      return {
        full_name,
        phone: phone10,
        email: email || null,
        address_line1,
        address_line2: address_line2 || null,
        city,
        state,
        pincode
      };
    };

    // ---------- Init ----------
    statusEl.textContent = "";

    // ---------- Coupon UI ----------
    // Always clear any previously stored coupon on page load
    localStorage.removeItem("ahamstree_coupon");
    appliedCoupon = "";

    // Available coupons to display in the panel
    const AVAILABLE_COUPONS = [
      { code: "WELCOME10", label: "10% off", description: "10% off your first order â€¢ No minimum spend" },
      { code: "AHAM15",    label: "15% off", description: "15% off on orders above â‚¹2,000" },
      { code: "SAREE5",    label: "â‚¹500 off", description: "Flat â‚¹500 off on sarees above â‚¹3,000" },
    ];

    const couponToggle   = document.getElementById("couponToggle");
    const couponPanel    = document.getElementById("couponPanel");
    const couponInput    = document.getElementById("couponInput");
    const applyCouponBtn = document.getElementById("applyCoupon");
    const couponOptions  = document.getElementById("couponOptions");
    const couponMsg      = document.getElementById("couponMsg");
    const couponToggleLabel = document.getElementById("couponToggleLabel");

    // Render available coupon chips
    if (couponOptions) {
      couponOptions.innerHTML = AVAILABLE_COUPONS.map(c => `
        <button type="button" class="coupon-chip" data-code="${c.code}"
          style="display:flex;align-items:center;justify-content:space-between;gap:10px;
                 border:1.5px dashed var(--border);border-radius:10px;padding:10px 12px;
                 background:#fafafa;cursor:pointer;text-align:left;width:100%;
                 transition:border-color .15s,background .15s;">
          <div>
            <span style="font-weight:800;font-size:13px;color:var(--brand);">${c.code}</span>
            <span style="margin-left:8px;font-size:12px;font-weight:700;background:var(--brand);color:#fff;padding:2px 7px;border-radius:999px;">${c.label}</span>
            <div style="font-size:12px;opacity:.7;margin-top:3px;">${c.description}</div>
          </div>
          <span style="font-size:12px;font-weight:800;color:var(--brand);white-space:nowrap;">Tap to apply â†’</span>
        </button>
      `).join("");

      couponOptions.querySelectorAll(".coupon-chip").forEach(btn => {
        btn.addEventListener("click", () => {
          const code = btn.dataset.code;
          if (couponInput) couponInput.value = code;
          applyCouponNow(code);
        });
      });
    }

    // Toggle panel open/close
    couponToggle?.addEventListener("click", () => {
      const isOpen = couponPanel.style.display !== "none";
      couponPanel.style.display = isOpen ? "none" : "block";
      couponToggle.style.borderStyle = isOpen ? "dashed" : "solid";
    });

    const applyCouponNow = async (code) => {
      code = String(code ?? couponInput?.value ?? "").trim().toUpperCase();
      appliedCoupon = code;
      if (code) {
        localStorage.setItem("ahamstree_coupon", code);
        if (couponToggleLabel) couponToggleLabel.textContent = `Coupon: ${code} âœ“`;
        couponToggle.style.background = "rgba(34,197,94,0.08)";
        couponToggle.style.borderColor = "rgba(34,197,94,0.5)";
        couponToggle.style.color = "#166534";
      } else {
        localStorage.removeItem("ahamstree_coupon");
        if (couponToggleLabel) couponToggleLabel.textContent = "Have a coupon? Tap to apply";
        couponToggle.style.background = "";
        couponToggle.style.borderColor = "";
        couponToggle.style.color = "";
      }
      await renderOrderSummary({ coupon_code: code });
    };

    applyCouponBtn?.addEventListener("click", () => applyCouponNow());
    couponInput?.addEventListener("keydown", (e) => {
      if (e.key === "Enter") { e.preventDefault(); applyCouponNow(); }
    });

    // â”€â”€ Saved address + login state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (async () => {
      const sbMod = await import("./assets/supabase.js");
      const { data: sess } = await sbMod.supabase.auth.getSession();
      const user  = sess?.session?.user;
      const loginHint = document.getElementById("loginHint");

      if (!user) {
        // Guest â€” show soft login nudge, but don't block
        if (loginHint) {
          loginHint.innerHTML = `<a href="login.html?next=checkout.html" style="color:var(--brand);font-weight:700;">Log in</a> to use your saved address.`;
        }
        return;
      }

      // Logged in â€” try to load profile address
      const { data: profile } = await sbMod.supabase
        .from("profiles")
        .select("full_name,phone,address_line1,address_line2,city,state,pincode")
        .eq("id", user.id)
        .maybeSingle();

      if (!profile || !profile.address_line1) return; // no saved address

      const banner  = document.getElementById("savedAddressBanner");
      const preview = document.getElementById("savedAddressPreview");
      if (!banner || !preview) return;

      const parts = [profile.address_line1, profile.address_line2, profile.city, profile.state, profile.pincode].filter(Boolean);
      preview.textContent = `${profile.full_name || ""} â€¢ ${parts.join(", ")}`;
      banner.style.display = "block";

      // "Use this address" â€” fills the form
      document.getElementById("useSavedAddress")?.addEventListener("click", () => {
        const set = (name, val) => {
          const el = form.querySelector(`[name="${name}"]`);
          if (el && val) { el.value = val; el.dataset.touched = "1"; }
        };
        set("full_name",    profile.full_name);
        set("phone",        profile.phone);
        set("address_line1", profile.address_line1);
        set("address_line2", profile.address_line2);
        set("city",         profile.city);
        set("state",        profile.state);
        set("pincode",      profile.pincode);
        banner.style.display = "none";
        validateAll({ showErrors: false });
      });

      // "Enter new" â€” just hide the banner
      document.getElementById("dismissSavedAddress")?.addEventListener("click", () => {
        banner.style.display = "none";
      });
    })();

    // First render â€” no coupon applied by default
    renderOrderSummary({ coupon_code: "" });
    attachLiveValidation();
    validateAll({ showErrors: false });

    // ---------- Pay ----------
    // ---------- Payment method toggle UI ----------
    const pmRazorpay    = document.getElementById("pmRazorpay");
    const pmCod         = document.getElementById("pmCod");
    const pmRazorpayLbl = document.getElementById("pmRazorpayLabel");
    const pmCodLbl      = document.getElementById("pmCodLabel");
    const codNote       = document.getElementById("codNote");
    const payNote       = document.getElementById("payNote");

    function getPaymentMethod() {
      return document.querySelector('input[name="payment_method"]:checked')?.value || "razorpay";
    }

    function updatePaymentUI() {
      const method = getPaymentMethod();
      const isRazorpay = method === "razorpay";

      // Highlight selected card
      pmRazorpayLbl.style.border  = isRazorpay ? "2px solid var(--brand)" : "2px solid var(--border)";
      pmRazorpayLbl.style.background = isRazorpay ? "var(--brand-light)" : "#fff";
      pmCodLbl.style.border       = !isRazorpay ? "2px solid var(--brand)" : "2px solid var(--border)";
      pmCodLbl.style.background   = !isRazorpay ? "var(--brand-light)" : "#fff";

      // Button label
      payBtn.textContent = isRazorpay ? "Pay with Razorpay" : "Place COD Order";

      // Show/hide COD note and footer note
      codNote.style.display = isRazorpay ? "none" : "block";
      if (payNote) payNote.textContent = isRazorpay
        ? "Payments are processed by Razorpay. You'll be redirected to a secure payment page."
        : "No payment needed now. Your order will be confirmed via WhatsApp / call.";
    }

    pmRazorpay?.addEventListener("change", updatePaymentUI);
    pmCod?.addEventListener("change", updatePaymentUI);
    updatePaymentUI(); // set initial state

    // ---------- Pay / Place Order ----------
    let isProcessing = false;

    payBtn.addEventListener("click", async () => {
      form.querySelectorAll("input[name]").forEach(i => (i.dataset.touched = "1"));
      const ok = validateAll({ showErrors: true });
      if (!ok) return;
      if (isProcessing) return;

      const method = getPaymentMethod();

      try {
        isProcessing = true;
        payBtn.disabled = true;
        clearError();

        const cartMod = await import("./assets/cart.js");
        const sbMod   = await import("./assets/supabase.js");

        const cart = cartMod.getCart?.() || [];
        if (!cart.length) {
          showError("Your cart is empty. Please add products first.");
          return;
        }

        const { data: sess } = await sbMod.supabase.auth.getSession();
        const session = sess?.session;
        const token   = session?.access_token ?? null;

        // Razorpay always requires login (payment link is tied to user account)
        if (method === "razorpay" && !token) {
          showError("Please log in to pay online. COD is available without logging in.");
          return;
        }

        const shipping     = buildShipping();
        const payloadCart  = cart.map(i => ({ product_id: i.product_id, qty: i.qty }));

        // â”€â”€ RAZORPAY FLOW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if (method === "razorpay") {
          payBtn.textContent = "Processingâ€¦";
          statusEl.textContent = "Creating payment linkâ€¦";

          const { data, error } = await sbMod.supabase.functions.invoke("create-payment-link", {
            body: {
              cart: payloadCart,
              coupon_code: (appliedCoupon || null),
              customer_name:  shipping.full_name,
              customer_phone: shipping.phone,
              customer_email: shipping.email || null,
              shipping_address: shipping,
              shipping_inr: 0
            },
            headers: { Authorization: `Bearer ${session.access_token}` }
          });

          if (error) { showError(error.message || "Payment setup failed."); return; }
          if (!data?.payment_link_url) { showError(data?.error || "Payment setup failed."); return; }

          statusEl.textContent = "Redirecting to Razorpayâ€¦";
          window.location.href = data.payment_link_url;

        // â”€â”€ CASH ON DELIVERY FLOW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        } else {
          payBtn.textContent = "Placing orderâ€¦";
          statusEl.textContent = "Placing your COD orderâ€¦";

          const codHeaders = token ? { Authorization: `Bearer ${token}` } : {};
          const { data, error } = await sbMod.supabase.functions.invoke("create-cod-order", {
            body: {
              cart: payloadCart,
              coupon_code: (appliedCoupon || null),
              customer_name:  shipping.full_name,
              customer_phone: shipping.phone,
              customer_email: shipping.email || null,
              shipping_address: shipping,
              shipping_inr: 0,
              payment_method: "cod"
            },
            headers: codHeaders
          });

          if (error) { showError(error.message || "Could not place COD order. Please try again."); return; }

          const orderId = data?.order_id || data?.id || "";

          // Clear cart
          cartMod.clearCart?.();

          statusEl.textContent = "Order placed! Redirectingâ€¦";
          window.location.href = "success.html" + (orderId ? `?order_id=${encodeURIComponent(orderId)}&method=cod` : "?method=cod");
        }

      } catch (e) {
        showError(String(e?.message ?? e));
        statusEl.textContent = "";
        console.error(e);
      } finally {
        isProcessing = false;
        payBtn.disabled = false;
        updatePaymentUI(); // restore correct button label
        validateAll({ showErrors: false });
      }
    });
  </script>

</body>
</html>
