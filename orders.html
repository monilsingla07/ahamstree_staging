<!doctype html>
<html>
<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-CKQ1EXBHY6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-CKQ1EXBHY6');
  </script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Orders â€” AhamStree</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/styles.css" />
  <style>
    .status-badge {
      display: inline-flex; align-items: center; gap: 5px;
      padding: 3px 10px; border-radius: 999px; font-size: 12px; font-weight: 800;
    }
    .status-badge.paid      { background: #dcfce7; color: #166534; }
    .status-badge.confirmed { background: #dcfce7; color: #166534; }
    .status-badge.shipped   { background: #dbeafe; color: #1e40af; }
    .status-badge.delivered { background: #f0fdf4; color: #14532d; border:1px solid #86efac; }
    .status-badge.pending   { background: #fef9c3; color: #854d0e; }
    .status-badge.failed    { background: #fee2e2; color: #991b1b; }
    .status-badge.cancelled { background: #f3f4f6; color: #6b7280; }
    .payment-pill {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 2px 8px; border-radius: 999px; font-size: 11px; font-weight: 700;
      background: #f3f4f6; color: #374151;
    }
    .payment-pill.cod     { background: #fff7ed; color: #9a3412; }
    .payment-pill.online  { background: #eff6ff; color: #1d4ed8; }
  </style>
</head>

<body>
  <div id="header"></div>

  <div class="container" style="max-width:860px;">
    <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:flex-start;">
      <div>
        <h2 style="margin:0;">My Orders</h2>
        <div class="small" style="margin-top:6px; opacity:.75;">Your orders and delivery status.</div>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <a class="btn secondary" href="account.html">Account</a>
        <a class="btn secondary" href="profile.html">Profile</a>
      </div>
    </div>

    <hr />

    <div id="statusMsg" class="small" style="margin-bottom:12px;">Loadingâ€¦</div>
    <div id="list" style="display:grid; gap:14px;"></div>
  </div>

  <div id="footer"></div>

  <script type="module">
    import { renderHeader, renderFooter, hydrateHeaderAuth } from "./assets/ui.js";
    import { supabase } from "./assets/supabase.js";
    import { escapeHtml, safeHref } from "./assets/safe.js";

    document.getElementById("header").innerHTML = renderHeader("account");
    document.getElementById("footer").innerHTML = renderFooter();
    hydrateHeaderAuth();

    const statusMsg = document.getElementById("statusMsg");
    const list      = document.getElementById("list");

    function money(v) {
      return "â‚¹" + Number(v || 0).toLocaleString("en-IN", { maximumFractionDigits: 0 });
    }

    function statusBadge(st) {
      const map = {
        paid:                  { label: "Paid",             cls: "paid"      },
        confirmed:             { label: "Confirmed",        cls: "confirmed" },
        payment_link_created:  { label: "Payment pending",  cls: "pending"   },
        payment_link_failed:   { label: "Link failed",      cls: "failed"    },
        created:               { label: "Payment pending",  cls: "pending"   },
        failed:                { label: "Payment failed",   cls: "failed"    },
        expired:               { label: "Link expired",     cls: "failed"    },
        cancelled:             { label: "Cancelled",        cls: "cancelled" },
        shipped:               { label: "Shipped",          cls: "shipped"   },
        delivered:             { label: "Delivered",        cls: "delivered" },
      };
      const s = map[st] || { label: st || "Unknown", cls: "pending" };
      return `<span class="status-badge ${s.cls}">${s.label}</span>`;
    }

    function paymentPill(method) {
      if (method === "cod") return `<span class="payment-pill cod">ðŸ’µ Cash on Delivery</span>`;
      return `<span class="payment-pill online">ðŸ’³ Online Payment</span>`;
    }

    function formatDate(iso) {
      if (!iso) return "â€”";
      return new Date(iso).toLocaleString("en-IN", {
        day: "numeric", month: "short", year: "numeric",
        hour: "2-digit", minute: "2-digit"
      });
    }

    function renderOrder(o) {
      const isCod     = o.payment_method === "cod";
      const isOnline  = !isCod;

      const payLink    = o.razorpay_payment_link_url;
      const safePayHref = safeHref(payLink);
      const canRetryPay = isOnline &&
        ["payment_link_created", "payment_link_failed", "created", "failed"].includes(o.status) &&
        !!safePayHref;

      const awb        = o.shiprocket_awb;
      const canTrack   = !!awb &&
        ["shipped", "delivered"].includes(o.status);

      const items = (o.order_items || [])
        .map(it => `
          <div style="display:flex; justify-content:space-between; gap:10px; padding:8px 0; border-bottom:1px solid var(--border-light);">
            <div class="small" style="flex:1;">
              ${Number(it.qty || 0)} Ã— ${escapeHtml(it.title)}
            </div>
            <div class="small" style="font-weight:700; flex-shrink:0;">${money(it.price_inr)}</div>
          </div>
        `)
        .join("");

      const shortId = escapeHtml(o.id.slice(0, 8).toUpperCase());

      // Discount row
      const discountRow = (Number(o.discount_inr) > 0)
        ? `<div style="display:flex;justify-content:space-between;gap:8px;margin-top:4px;">
             <div class="small" style="opacity:.7;">Discount</div>
             <div class="small" style="color:green; font-weight:700;">âˆ’${money(o.discount_inr)}</div>
           </div>`
        : "";

      return `
        <div class="card" style="border-radius:16px; overflow:hidden;">

          <!-- Header row -->
          <div style="padding:14px 16px; display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap; border-bottom:1px solid var(--border-light);">
            <div>
              <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin-bottom:6px;">
                <span style="font-weight:900; font-size:15px;">Order #${shortId}</span>
                ${statusBadge(o.status)}
                ${paymentPill(o.payment_method)}
              </div>
              <div class="small" style="opacity:.65;">${formatDate(o.created_at)}</div>
            </div>

            <!-- Action buttons -->
            <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
              ${canRetryPay
                ? `<a class="btn" style="padding:8px 14px; font-size:13px;"
                     href="${safePayHref}" target="_blank" rel="noopener noreferrer">
                     Pay now â†’
                   </a>`
                : ""}
              ${canTrack
                ? `<a class="btn secondary" style="padding:8px 14px; font-size:13px;"
                     href="track.html?awb=${encodeURIComponent(awb)}">
                     Track order
                   </a>`
                : ""}
            </div>
          </div>

          <!-- Items -->
          <div style="padding:12px 16px;">
            ${items || `<div class="small" style="opacity:.6;">No items found.</div>`}
          </div>

          <!-- Totals -->
          <div style="padding:12px 16px; border-top:1px solid var(--border-light); background:#fafafa;">
            ${discountRow}
            <div style="display:flex; justify-content:space-between; gap:8px; margin-top:4px;">
              <div class="small" style="opacity:.7;">Shipping</div>
              <div class="small">${money(o.shipping_inr)}</div>
            </div>
            <div style="display:flex; justify-content:space-between; gap:8px; margin-top:8px; font-weight:900;">
              <div>Total</div>
              <div>${money(o.total_inr)}</div>
            </div>
          </div>

          <!-- COD pending note -->
          ${(isCod && o.status === "confirmed")
            ? `<div style="padding:10px 16px; background:#fff7ed; border-top:1px solid #fed7aa;">
                 <div class="small" style="color:#9a3412;">
                   ðŸ“¦ COD order â€” our team will contact you to confirm dispatch.
                 </div>
               </div>`
            : ""}

          <!-- Shipping info (when available) -->
          ${awb
            ? `<div style="padding:10px 16px; background:#eff6ff; border-top:1px solid #bfdbfe;">
                 <div class="small" style="color:#1e40af;">
                   ðŸšš AWB: <strong>${escapeHtml(awb)}</strong>
                   ${canTrack ? `â€” <a href="track.html?awb=${encodeURIComponent(awb)}" style="color:inherit;">Track â†’</a>` : ""}
                 </div>
               </div>`
            : ""}
        </div>
      `;
    }

    async function loadOrders() {
      const { data: sess } = await supabase.auth.getSession();
      const user = sess?.session?.user;
      if (!user) {
        window.location.href = "login.html?next=orders.html";
        return;
      }

      const { data, error } = await supabase
        .from("orders")
        .select(`
          id, status, payment_method,
          subtotal_inr, shipping_inr, discount_inr, total_inr,
          razorpay_payment_link_url, shiprocket_awb,
          created_at,
          order_items(qty, title, price_inr)
        `)
        .eq("user_id", user.id)
        .order("created_at", { ascending: false });

      if (error) {
        statusMsg.textContent = "Could not load orders: " + error.message;
        return;
      }

      const orders = data ?? [];
      statusMsg.textContent = orders.length ? "" : "You have no orders yet.";
      list.innerHTML = orders.map(renderOrder).join("");
    }

    loadOrders();
  </script>
</body>
</html>
