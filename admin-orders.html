<!doctype html>
<html>
<head>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-CKQ1EXBHY6"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-CKQ1EXBHY6');
</script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Orders — AhamStree</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="assets/styles.css" />
</head>
<body>
  <div id="header"></div>

  <div class="container">
    <h2 style="margin-top:0;">Orders</h2>

    <div class="row" style="margin-bottom:12px;">
      <select id="statusFilter" class="input" style="max-width:260px;">
        <option value="">All</option>
        <option value="payment_link_created">Pending</option>
        <option value="payment_failed">Failed</option>
        <option value="expired">Expired</option>
        <option value="paid">Paid</option>
      </select>

      <input id="search" class="input" placeholder="Search by phone or order id…" style="max-width:320px;" />
      <button id="load" class="btn">Load</button>
      <a class="btn secondary" href="admin.html">Back</a>
    </div>

    <div id="status" class="small"></div>
    <div id="list" style="margin-top:12px;display:grid;gap:12px;"></div>
  </div>

  <div id="footer"></div>

  <script type="module">
    import { renderHeader, renderFooter, hydrateHeaderAuth } from "./assets/ui.js";
    import { supabase } from "./assets/supabase.js";
	    import { escapeHtml, escapeAttr, safeHref, safeUrl } from "./assets/safe.js";

    document.getElementById("header").innerHTML = renderHeader("admin");
    document.getElementById("footer").innerHTML = renderFooter();
    hydrateHeaderAuth();

    const statusEl = document.getElementById("status");
    const list = document.getElementById("list");

    const { data: sess } = await supabase.auth.getSession();
    if (!sess?.session) window.location.href = "login.html";

    const statusFilter = document.getElementById("statusFilter");
    const search = document.getElementById("search");
    document.getElementById("load").onclick = load;

    function waLink(phone, text) {
      const p = String(phone || "").replace(/\D/g, "");
      const msg = encodeURIComponent(text);
      return `https://wa.me/${p}?text=${msg}`;
    }

	    function renderOrder(o) {
	      const orderIdText = escapeHtml(o.id);
	      const orderIdAttr = escapeAttr(o.id);
	      const statusText = escapeHtml(o.status);
	      const customerNameText = escapeHtml(o.customer_name || "-");
	      const customerPhoneText = escapeHtml(o.customer_phone || "-");
	      const phone = o.customer_phone || "";
	      const payHref = o.razorpay_payment_link_url ? safeHref(o.razorpay_payment_link_url) : "";

	      const items = (o.order_items || []).map(it => {
	        const t = escapeHtml(it.title);
	        return `<div class="small">${Number(it.qty) || 0} × ${t} — ₹${Number(it.price_inr || 0)}</div>`;
	      }).join("");

	      const total = "₹" + Number(o.total_inr || 0).toLocaleString("en-IN");

	      const reminderMsg = `Hi ${o.customer_name || "there"}, your AhamStree order (${o.id}) is pending. Please complete payment here: ${o.razorpay_payment_link_url || ""}`;

	      return `
        <div class="card">
          <div class="p">
            <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;">
              <div>
                <div style="font-weight:900;">Order ${orderIdText}</div>
                <div class="small">Status: <b>${statusText}</b> • Total: <b>${total}</b></div>
                <div class="small">Customer: ${customerNameText} • ${customerPhoneText}</div>
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:flex-start;">
                ${payHref ? `<a class="btn secondary" target="_blank" rel="noopener noreferrer" href="${payHref}">Payment Link</a>` : ""}
                <button class="btn secondary" data-action="regen" data-id="${orderIdAttr}">Regenerate Link</button>
                <button class="btn" data-action="invoice" data-id="${orderIdAttr}">Generate Invoice PDF</button>
              </div>
            </div>

            <hr/>
            ${items}

            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;">
              ${phone ? `<a class="btn secondary" target="_blank" rel="noopener noreferrer" href="${safeHref(waLink(phone, reminderMsg))}">WhatsApp Reminder</a>` : ""}
              ${phone ? `<a class="btn secondary is-disabled" aria-disabled="true" href="#" target="_blank" rel="noopener noreferrer" data-wa="invoice" data-phone="${escapeAttr(phone)}" data-id="${orderIdAttr}">Send Invoice on WhatsApp</a>` : ""}
            </div>

            <div class="small" style="margin-top:8px;">
              Created: ${new Date(o.created_at).toLocaleString("en-IN")}
            </div>
          </div>
        </div>
      `;
    }

    async function load() {
      statusEl.textContent = "Loading…";
      list.innerHTML = "";

      const st = statusFilter.value;
      const q = search.value.trim();

      const url = `admin-orders?status=${encodeURIComponent(st)}&q=${encodeURIComponent(q)}`;
      const { data, error } = await supabase.functions.invoke(url);

      if (error) {
        statusEl.textContent = "Error / Access denied: " + error.message;
        return;
      }

      statusEl.textContent = "";
      const orders = data.orders || [];
      list.innerHTML = orders.map(renderOrder).join("");

      // Prevent clicking the invoice WhatsApp link before invoice is generated
      list.querySelectorAll("a[data-wa='invoice']").forEach(a => {
        a.addEventListener("click", (e) => {
          if (a.classList.contains("is-disabled")) {
            e.preventDefault();
            alert("Please generate the invoice first, then click 'Send Invoice on WhatsApp' again.");
          }
        });
      });

      // wire buttons
      list.querySelectorAll("button[data-action='invoice']").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          btn.disabled = true;
          btn.textContent = "Generating…";

          const { data: inv, error: invErr } = await supabase.functions.invoke("admin-generate-invoice", {
            body: { order_id: id }
          });

          btn.disabled = false;
          btn.textContent = "Generate Invoice PDF";

          if (invErr) {
            alert("Invoice error: " + invErr.message);
            return;
          }

          // open invoice URL (securely)
          const invUrl = safeUrl(inv.invoice_url, { type: "href" });
          if (!invUrl) {
            alert("Invoice URL is invalid.");
            return;
          }
          const w = window.open(invUrl, "_blank", "noopener,noreferrer");
          if (w) w.opener = null;

          // update the WhatsApp invoice link button (if exists)
          const waBtn = list.querySelector(`a[data-wa='invoice'][data-id='${id}']`);
          if (waBtn) {
            const phone = waBtn.getAttribute("data-phone");
            const msg = `Hi, thanks for your AhamStree order (${id}). Here is your invoice: ${inv.invoice_url}`;
            waBtn.href = waLink(phone, msg);
            waBtn.classList.remove("is-disabled");
            waBtn.removeAttribute("aria-disabled");
          }
        });
      });

      list.querySelectorAll("button[data-action='regen']").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          btn.disabled = true;
          btn.textContent = "Working…";

          const { data: r, error: rErr } = await supabase.functions.invoke("admin-regenerate-payment-link", {
            body: { order_id: id }
          });

          btn.disabled = false;
          btn.textContent = "Regenerate Link";

          if (rErr) {
            alert("Regenerate error: " + rErr.message);
            return;
          }
          alert("New payment link created.");
          load();
        });
      });
    }

    load();
  </script>
</body>
</html>
