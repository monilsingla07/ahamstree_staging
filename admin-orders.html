<!doctype html>
<html>
<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-CKQ1EXBHY6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-CKQ1EXBHY6');
  </script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Orders â€” AhamStree</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/styles.css" />

  <style>
    /* Status badges */
    .sbadge { display:inline-flex;align-items:center;padding:3px 10px;border-radius:999px;font-size:11px;font-weight:800; }
    .sbadge.confirmed    { background:#dcfce7;color:#166534; }
    .sbadge.paid         { background:#dcfce7;color:#166534; }
    .sbadge.shipped      { background:#dbeafe;color:#1e40af; }
    .sbadge.delivered    { background:#f0fdf4;color:#14532d;border:1px solid #86efac; }
    .sbadge.pending      { background:#fef9c3;color:#854d0e; }
    .sbadge.failed       { background:#fee2e2;color:#991b1b; }
    .sbadge.cancelled    { background:#f3f4f6;color:#6b7280; }

    /* Payment method pill */
    .pm-pill { display:inline-flex;align-items:center;padding:2px 8px;border-radius:999px;font-size:11px;font-weight:700; }
    .pm-pill.cod    { background:#fff7ed;color:#9a3412; }
    .pm-pill.online { background:#eff6ff;color:#1d4ed8; }

    /* COD action card â€” highlighted */
    .cod-action-bar { background:#fff7ed;border-top:1px solid #fed7aa;padding:12px 16px; }

    /* Inline AWB input row */
    .awb-row { display:flex;gap:8px;align-items:center;margin-top:8px; }
    .awb-row input { flex:1;min-width:0; }

    /* Toast */
    #toast {
      position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(20px);
      background:#111;color:#fff;padding:10px 20px;border-radius:12px;font-size:13px;
      font-weight:700;opacity:0;transition:all .25s ease;pointer-events:none;z-index:999;
      white-space:nowrap;
    }
    #toast.show { opacity:1;transform:translateX(-50%) translateY(0); }
  </style>
</head>

<body>
  <div id="header"></div>

  <div class="container" style="max-width:980px;">

    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap;margin-bottom:16px;">
      <div>
        <h2 style="margin:0;">Admin â€” Orders</h2>
        <div class="small" style="opacity:.7;margin-top:4px;">Manage all orders. COD orders need manual shipping action.</div>
      </div>
      <a class="btn secondary" href="admin.html">â† Back to admin</a>
    </div>

    <!-- Filters -->
    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px;align-items:center;">
      <select id="statusFilter" class="input" style="max-width:220px;">
        <option value="">All statuses</option>
        <option value="confirmed">COD Confirmed (needs shipping)</option>
        <option value="paid">Paid (needs shipping)</option>
        <option value="payment_link_created">Payment pending</option>
        <option value="shipped">Shipped</option>
        <option value="delivered">Delivered</option>
        <option value="failed">Failed / Expired</option>
        <option value="cancelled">Cancelled</option>
      </select>
      <select id="methodFilter" class="input" style="max-width:180px;">
        <option value="">All payment types</option>
        <option value="cod">Cash on Delivery</option>
        <option value="razorpay">Online (Razorpay)</option>
      </select>
      <input id="search" class="input" placeholder="Search phone or order IDâ€¦" style="max-width:280px;" />
      <button id="btnLoad" class="btn">Refresh</button>
    </div>

    <div id="statusMsg" class="small" style="margin-bottom:10px;"></div>
    <div id="list" style="display:grid;gap:14px;"></div>
  </div>

  <div id="toast"></div>
  <div id="footer"></div>

  <script type="module">
    import { renderHeader, renderFooter, hydrateHeaderAuth } from "./assets/ui.js";
    import { supabase } from "./assets/supabase.js";
    import { escapeHtml, escapeAttr, safeHref, safeUrl } from "./assets/safe.js";

    document.getElementById("header").innerHTML = renderHeader("admin");
    document.getElementById("footer").innerHTML = renderFooter();
    hydrateHeaderAuth();

    // â”€â”€ Auth check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const { data: sess } = await supabase.auth.getSession();
    if (!sess?.session) { window.location.href = "login.html"; }

    // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const statusMsg = document.getElementById("statusMsg");
    const list      = document.getElementById("list");

    function money(v) {
      return "â‚¹" + Number(v || 0).toLocaleString("en-IN", { maximumFractionDigits: 0 });
    }

    function toast(msg, color = "#111") {
      const el = document.getElementById("toast");
      el.textContent = msg;
      el.style.background = color;
      el.classList.add("show");
      setTimeout(() => el.classList.remove("show"), 3000);
    }

    function statusBadge(st) {
      const map = {
        confirmed:            { label: "COD Confirmed",    cls: "confirmed" },
        paid:                 { label: "Paid",             cls: "paid"      },
        payment_link_created: { label: "Payment pending",  cls: "pending"   },
        payment_link_failed:  { label: "Link failed",      cls: "failed"    },
        created:              { label: "Payment pending",  cls: "pending"   },
        failed:               { label: "Failed",           cls: "failed"    },
        expired:              { label: "Expired",          cls: "failed"    },
        shipped:              { label: "Shipped",          cls: "shipped"   },
        delivered:            { label: "Delivered",        cls: "delivered" },
        cancelled:            { label: "Cancelled",        cls: "cancelled" },
      };
      const s = map[st] || { label: st || "Unknown", cls: "pending" };
      return `<span class="sbadge ${s.cls}">${s.label}</span>`;
    }

    function paymentPill(method) {
      if (method === "cod") return `<span class="pm-pill cod">ğŸ’µ COD</span>`;
      return `<span class="pm-pill online">ğŸ’³ Online</span>`;
    }

    function waLink(phone, text) {
      const p = String(phone || "").replace(/\D/g, "");
      const full = p.length === 10 ? "91" + p : p;
      return `https://wa.me/${full}?text=${encodeURIComponent(text)}`;
    }

    function renderOrder(o) {
      const isCod   = o.payment_method === "cod";
      const isOnline = !isCod;
      const needsShipping = ["confirmed", "paid"].includes(o.status) && !o.shiprocket_awb;
      const isShipped     = ["shipped", "delivered"].includes(o.status) || !!o.shiprocket_awb;

      const payHref   = o.razorpay_payment_link_url ? safeHref(o.razorpay_payment_link_url) : "";
      const canRegen  = isOnline && ["payment_link_created","payment_link_failed","created","failed"].includes(o.status);
      const canPay    = isOnline && canRegen && !!payHref;

      const phone      = o.customer_phone || "";
      const shortId    = o.id.slice(0, 8).toUpperCase();
      const addr       = o.shipping_address;
      const addrText   = addr
        ? [addr.address_line1, addr.address_line2, addr.city, addr.state, addr.pincode].filter(Boolean).join(", ")
        : "â€”";

      const items = (o.order_items || []).map(it =>
        `<div class="small" style="padding:5px 0;border-bottom:1px solid var(--border-light);">
           ${Number(it.qty) || 0} Ã— ${escapeHtml(it.title)}
           <span style="float:right;font-weight:700;">${money(it.price_inr)}</span>
         </div>`
      ).join("");

      const discountRow = Number(o.discount_inr) > 0
        ? `<div style="display:flex;justify-content:space-between;gap:8px;margin-top:4px;">
             <span class="small" style="opacity:.7;">Discount</span>
             <span class="small" style="color:green;font-weight:700;">âˆ’${money(o.discount_inr)}</span>
           </div>` : "";

      // WhatsApp message templates
      const confirmMsg  = `Hi ${escapeHtml(o.customer_name || "there")}, your AhamStree Cash on Delivery order (#${shortId}) is confirmed! Total: ${money(o.total_inr)}. We'll dispatch it soon. ğŸ™`;
      const shippedMsg  = `Hi ${escapeHtml(o.customer_name || "there")}, your AhamStree order (#${shortId}) has been shipped! ğŸ‰ Track it here: ${window.location.origin}/track.html?awb=${encodeURIComponent(o.shiprocket_awb || "")}`;
      const reminderMsg = `Hi ${escapeHtml(o.customer_name || "there")}, your AhamStree order (#${shortId}) payment is pending. Complete it here: ${o.razorpay_payment_link_url || ""}`;

      return `
        <div class="card" style="border-radius:16px;overflow:hidden;" data-order-id="${escapeAttr(o.id)}">

          <!-- Header -->
          <div style="padding:14px 16px;display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;">
            <div>
              <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:6px;">
                <span style="font-weight:900;">Order #${shortId}</span>
                ${statusBadge(o.status)}
                ${paymentPill(o.payment_method)}
                ${needsShipping ? `<span style="background:#fef3c7;color:#b45309;font-size:11px;font-weight:800;padding:2px 8px;border-radius:999px;">âš  Needs shipping</span>` : ""}
              </div>
              <div class="small" style="opacity:.7;">${new Date(o.created_at).toLocaleString("en-IN", {day:"numeric",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"})}</div>
            </div>

            <!-- Admin action buttons -->
            <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
              ${canPay  ? `<a class="btn secondary" style="padding:8px 12px;font-size:12px;" href="${payHref}" target="_blank" rel="noopener noreferrer">View payment link</a>` : ""}
              ${canRegen ? `<button class="btn secondary" style="padding:8px 12px;font-size:12px;" data-action="regen" data-id="${escapeAttr(o.id)}">Regenerate link</button>` : ""}
              <button class="btn secondary" style="padding:8px 12px;font-size:12px;" data-action="invoice" data-id="${escapeAttr(o.id)}">Generate invoice</button>
            </div>
          </div>

          <!-- Customer + address -->
          <div style="padding:0 16px 12px;display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <div>
              <div class="small" style="font-weight:800;opacity:.6;margin-bottom:4px;">CUSTOMER</div>
              <div style="font-weight:700;">${escapeHtml(o.customer_name || "â€”")}</div>
              <div class="small">${escapeHtml(phone || "â€”")}</div>
              ${o.customer_email ? `<div class="small" style="opacity:.7;">${escapeHtml(o.customer_email)}</div>` : ""}
            </div>
            <div>
              <div class="small" style="font-weight:800;opacity:.6;margin-bottom:4px;">SHIP TO</div>
              <div class="small" style="line-height:1.5;">${escapeHtml(addrText)}</div>
            </div>
          </div>

          <!-- Order items -->
          <div style="padding:0 16px 12px;">
            <div class="small" style="font-weight:800;opacity:.6;margin-bottom:6px;">ITEMS</div>
            ${items || `<div class="small" style="opacity:.6;">No items.</div>`}
          </div>

          <!-- Totals -->
          <div style="padding:10px 16px;border-top:1px solid var(--border-light);background:#fafafa;font-size:13px;">
            ${discountRow}
            <div style="display:flex;justify-content:space-between;gap:8px;margin-top:4px;">
              <span style="opacity:.7;">Shipping</span><span>${money(o.shipping_inr)}</span>
            </div>
            <div style="display:flex;justify-content:space-between;gap:8px;margin-top:6px;font-weight:900;">
              <span>Total</span><span>${money(o.total_inr)}</span>
            </div>
          </div>

          <!-- WhatsApp quick actions -->
          ${phone ? `
          <div style="padding:10px 16px;border-top:1px solid var(--border-light);display:flex;gap:8px;flex-wrap:wrap;">
            <div class="small" style="width:100%;font-weight:800;opacity:.6;margin-bottom:2px;">WHATSAPP</div>
            ${isCod ? `<a class="btn secondary" style="padding:7px 12px;font-size:12px;" href="${safeHref(waLink(phone, confirmMsg))}" target="_blank" rel="noopener noreferrer">âœ… Confirm COD order</a>` : ""}
            ${o.shiprocket_awb ? `<a class="btn secondary" style="padding:7px 12px;font-size:12px;" href="${safeHref(waLink(phone, shippedMsg))}" target="_blank" rel="noopener noreferrer">ğŸšš Share tracking</a>` : ""}
            ${isOnline && canRegen ? `<a class="btn secondary" style="padding:7px 12px;font-size:12px;" href="${safeHref(waLink(phone, reminderMsg))}" target="_blank" rel="noopener noreferrer">ğŸ”” Payment reminder</a>` : ""}
            <a class="btn secondary" data-wa-invoice href="#" style="padding:7px 12px;font-size:12px;" data-phone="${escapeAttr(phone)}" data-id="${escapeAttr(o.id)}">ğŸ“„ Send invoice</a>
          </div>` : ""}

          <!-- COD shipping action bar â€” only shown when order needs to be shipped -->
          ${needsShipping ? `
          <div class="cod-action-bar">
            <div style="font-weight:800;font-size:13px;margin-bottom:8px;">
              ${isCod ? "ğŸ“¦ Mark as shipped (COD)" : "ğŸ“¦ Mark as shipped"}
            </div>
            <div class="small" style="opacity:.8;margin-bottom:10px;">
              Once you've created the shipment in Shiprocket, enter the AWB number below to mark this order as shipped. The customer will be able to track it.
            </div>
            <div class="awb-row">
              <input class="input awb-input" placeholder="Enter Shiprocket AWB number (e.g. 788830567028)"
                     data-id="${escapeAttr(o.id)}" style="font-size:13px;" />
              <button class="btn" style="padding:10px 16px;font-size:13px;white-space:nowrap;"
                      data-action="ship" data-id="${escapeAttr(o.id)}">
                Mark shipped â†’
              </button>
            </div>
          </div>` : ""}

          <!-- AWB info when already shipped -->
          ${isShipped && o.shiprocket_awb ? `
          <div style="padding:10px 16px;background:#eff6ff;border-top:1px solid #bfdbfe;">
            <div class="small" style="color:#1e40af;">
              ğŸšš AWB: <strong>${escapeHtml(o.shiprocket_awb)}</strong>
              &nbsp;â€¢&nbsp;
              <a href="track.html?awb=${encodeURIComponent(o.shiprocket_awb)}" target="_blank" style="color:inherit;font-weight:700;">View tracking â†’</a>
            </div>
          </div>` : ""}

          <!-- Status change (delivered / cancelled) -->
          ${["shipped","confirmed","paid"].includes(o.status) ? `
          <div style="padding:10px 16px;border-top:1px solid var(--border-light);display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <div class="small" style="font-weight:800;opacity:.6;">UPDATE STATUS:</div>
            ${o.status === "shipped" ? `
              <button class="btn secondary" style="padding:7px 12px;font-size:12px;" data-action="status" data-id="${escapeAttr(o.id)}" data-status="delivered">
                âœ… Mark delivered
              </button>` : ""}
            <button class="btn secondary" style="padding:7px 12px;font-size:12px;color:crimson;border-color:crimson;"
                    data-action="status" data-id="${escapeAttr(o.id)}" data-status="cancelled">
              Cancel order
            </button>
          </div>` : ""}
        </div>
      `;
    }

    // â”€â”€ Load orders â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function load() {
      statusMsg.textContent = "Loadingâ€¦";
      list.innerHTML = "";

      const st     = document.getElementById("statusFilter").value;
      const method = document.getElementById("methodFilter").value;
      const q      = document.getElementById("search").value.trim();

      let params = "";
      if (st)     params += `&status=${encodeURIComponent(st)}`;
      if (q)      params += `&q=${encodeURIComponent(q)}`;
      const url = `admin-orders?dummy=1${params}`;

      const { data, error } = await supabase.functions.invoke(url.replace("?dummy=1",""));

      if (error) {
        statusMsg.textContent = "Error / Access denied: " + error.message;
        return;
      }

      let orders = data.orders || [];

      // Client-side filter by payment method (admin-orders function doesn't support it yet)
      if (method) orders = orders.filter(o => (o.payment_method || "razorpay") === method);

      statusMsg.textContent = orders.length
        ? `Showing ${orders.length} order${orders.length > 1 ? "s" : ""}`
        : "No orders found.";

      list.innerHTML = orders.map(renderOrder).join("");
      wireEvents();
    }

    // â”€â”€ Wire all button events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function wireEvents() {

      // Mark shipped â€” saves AWB + changes status to "shipped"
      list.querySelectorAll("button[data-action='ship']").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id      = btn.dataset.id;
          const card    = btn.closest("[data-order-id]");
          const awbInput = card?.querySelector(".awb-input");
          const awb     = (awbInput?.value || "").trim();

          if (!awb) { toast("Please enter the AWB number first", "#dc2626"); return; }

          btn.disabled = true;
          btn.textContent = "Savingâ€¦";

          const { error } = await supabase
            .from("orders")
            .update({
              status: "shipped",
              shiprocket_awb: awb,
              updated_at: new Date().toISOString()
            })
            .eq("id", id);

          if (error) {
            toast("Error: " + error.message, "#dc2626");
            btn.disabled = false;
            btn.textContent = "Mark shipped â†’";
            return;
          }

          // Log event
          await supabase.from("order_events").insert({
            order_id: id,
            event_type: "order_shipped",
            payload: { shiprocket_awb: awb, set_by: "admin" }
          });

          toast("Order marked as shipped âœ…", "#166534");
          load();
        });
      });

      // Update status (delivered / cancelled)
      list.querySelectorAll("button[data-action='status']").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id        = btn.dataset.id;
          const newStatus = btn.dataset.status;
          if (!confirm(`Mark order ${id.slice(0,8).toUpperCase()} as "${newStatus}"?`)) return;

          btn.disabled = true;
          const { error } = await supabase
            .from("orders")
            .update({ status: newStatus, updated_at: new Date().toISOString() })
            .eq("id", id);

          if (error) { toast("Error: " + error.message, "#dc2626"); btn.disabled = false; return; }

          await supabase.from("order_events").insert({
            order_id: id,
            event_type: `order_status_set:${newStatus}`,
            payload: { set_by: "admin" }
          });

          toast(`Order marked as ${newStatus} âœ…`, "#166534");
          load();
        });
      });

      // Regenerate Razorpay payment link
      list.querySelectorAll("button[data-action='regen']").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.dataset.id;
          btn.disabled = true;
          btn.textContent = "Workingâ€¦";

          const { data: r, error } = await supabase.functions.invoke("admin-regenerate-payment-link", {
            body: { order_id: id }
          });

          btn.disabled = false;
          btn.textContent = "Regenerate link";

          if (error) { toast("Error: " + error.message, "#dc2626"); return; }
          toast("New payment link created âœ…", "#166534");
          load();
        });
      });

      // Generate invoice PDF
      list.querySelectorAll("button[data-action='invoice']").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.dataset.id;
          btn.disabled = true;
          btn.textContent = "Generatingâ€¦";

          const { data: inv, error } = await supabase.functions.invoke("admin-generate-invoice", {
            body: { order_id: id }
          });

          btn.disabled = false;
          btn.textContent = "Generate invoice";

          if (error) { toast("Invoice error: " + error.message, "#dc2626"); return; }

          const invUrl = safeUrl(inv.invoice_url, { type: "href" });
          if (!invUrl) { toast("Invalid invoice URL", "#dc2626"); return; }

          const w = window.open(invUrl, "_blank", "noopener,noreferrer");
          if (w) w.opener = null;

          // Activate "Send invoice" WhatsApp button for this order
          const card   = list.querySelector(`[data-order-id="${id}"]`);
          const waBtn  = card?.querySelector("a[data-wa-invoice]");
          if (waBtn) {
            const phone = waBtn.dataset.phone;
            const msg   = `Hi, your AhamStree order invoice is ready: ${inv.invoice_url}`;
            waBtn.href  = `https://wa.me/${phone.replace(/\D/g,"")}?text=${encodeURIComponent(msg)}`;
            waBtn.removeAttribute("aria-disabled");
            waBtn.style.opacity = "1";
          }

          toast("Invoice generated âœ…", "#166534");
        });
      });
    }

    // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById("btnLoad").onclick = load;
    document.getElementById("statusFilter").onchange = load;
    document.getElementById("methodFilter").onchange = load;

    load();
  </script>
</body>
</html>
